<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Organizer & Timer</title>
    <style>
        body {
            background-color: #121212; 
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            transition: background-color 2s ease; 
        }
        .container {
            text-align: center;
            background: rgba(30, 30, 30, 0.8);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.5);
            max-width: 600px;
            width: 100%;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        h1, h2 { margin-top: 0; }
        
        .page { display: none; animation: fadeIn 1s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #timer-display {
            font-size: 5rem;
            font-weight: bold;
            margin: 20px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
            text-align: left;
        }
        input, select {
            padding: 10px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: white;
            width: 100%;
            box-sizing: border-box;
        }
        .time-row { display: flex; gap: 10px; }
        .time-row input { text-align: center; }

        .controls { display: flex; justify-content: center; gap: 10px; }
        button {
            padding: 10px 20px;
            font-size: 1rem;
            border: none;
            border-radius: 6px;
            background-color: #0078D7;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            font-weight: 500;
        }
        button:hover { background-color: #005a9e; }
        
        #calendar-btn { background-color: #107c41; margin-top: 5px; } 
        #calendar-btn:hover { background-color: #0c5e31; }
        #pause-btn { background-color: #e6a000; color: black; font-weight: bold; }
        #pause-btn:hover { background-color: #c98c00; }
        #finish-btn { background-color: #d13438; }
        #finish-btn:hover { background-color: #b02a2e; }
        
        /* --- DASHBOARD & CALENDAR STYLES --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #444;
        }
        .stat-title { font-size: 0.9rem; color: #aaaaaa; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #4caf50; }

        .calendar-list {
            text-align: left;
            font-size: 1.1rem;
            line-height: 1.8;
            padding-left: 0;
            list-style-type: none;
            margin-top: 20px;
        }
        .calendar-list li {
            background: #2a2a2a;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #0078D7;
        }
        .event-time { color: #aaaaaa; font-size: 0.95rem; margin-right: 10px; }
        .event-title { font-weight: bold; }

        #wake-status { margin-top: 30px; font-size: 0.8rem; color: #888888; }
        #sync-status { font-size: 0.9rem; color: #4caf50; margin-top: 10px; display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div id="page-0" class="page active">
            <h1>Current Focus</h1>
            
            <div id="setup-controls" class="input-group">
                <input type="text" id="task-name" placeholder="E.g., Review Qualifying Exam materials">
                
                <div class="time-row">
                    <select id="task-category">
                        <option value="Materials Science">Materials Science</option>
                        <option value="Python/Coding">Python/Coding</option>
                        <option value="Errands/Personal">Errands/Personal</option>
                        <option value="Cat Care">Cat Care</option>
                        <option value="Other">Other</option>
                    </select>
                    <input type="number" id="minutes-input" placeholder="Total Mins" min="1" value="60">
                </div>
                
                <button onclick="startNewTask()">Start Task</button>
                <button id="calendar-btn" onclick="exportToICS()">ðŸ“… Add to Calendar</button>
            </div>

            <div class="controls" id="active-controls" style="display: none;">
                <button id="pause-btn" onclick="togglePause()">Pause</button>
                <button id="finish-btn" onclick="finishTask()">Finish & Log Task</button>
            </div>

            <div id="timer-display">00:00:00</div>
            <div id="pomodoro-plan" style="font-size: 1.1rem; color: #0078D7;"></div>
            <div id="sync-status">Logging to Google Sheets... ðŸ”„</div>
        </div>

        <div id="page-1" class="page">
            <h2>Sheet Analytics</h2>
            <div id="dashboard-stats" class="dashboard-grid">
                <p>Loading analytics...</p>
            </div>
        </div>

        <div id="page-2" class="page">
            <h2>Upcoming Schedule</h2>
            <ul id="calendar-events-list" class="calendar-list">
                <p>Loading calendar...</p>
            </ul>
        </div>

        <div id="wake-status">Screen Wake Lock: Inactive ðŸŒ™ | Screensaver: Off</div>
    </div>

    <script>
        // --- YOUR LIVE GOOGLE SCRIPT URL ---
        const GOOGLE_SCRIPT_URL = "YOUR_URL_HERE"; 

        // --- GLOBALS ---
        let countdownInterval;
        let screensaverInterval;
        let wakeLock = null;
        let timeRemainingMs = 0;
        let endTimeMs = 0;
        let isPaused = false;
        
        let sessionDate = "";
        let sessionStartTime = "";
        
        let currentPageIndex = 0;
        const totalPages = 3; 
        const burnInColors = ['#121212', '#0f172a', '#1e1b4b', '#2e1065', '#1a1110', '#0a192f'];

        // --- FETCH DATA ON LOAD ---
        window.onload = async () => {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, { method: "GET", redirect: "follow" });
                const payload = await response.json();
                
                // 1. RENDER SPREADSHEET STATS (Page 1)
                const stats = payload.stats;
                if (stats && Object.keys(stats).length > 0) {
                    const statsHTML = Object.keys(stats).map(key => `
                        <div class="stat-card">
                            <div class="stat-title">${key}</div>
                            <div class="stat-value">${stats[key]}</div>
                        </div>
                    `).join('');
                    document.getElementById('dashboard-stats').innerHTML = statsHTML;
                } else {
                    document.getElementById('dashboard-stats').innerHTML = "<p>No stat data found.</p>";
                }

                // 2. RENDER CALENDAR EVENTS (Page 2)
                const events = payload.events;
                if (events && events.length > 0) {
                    // Limit to the next 6 events so the screen isn't overwhelmed
                    const eventsHTML = events.slice(0, 6).map(ev => {
                        const dateObj = new Date(ev.startTime);
                        // Format: Mon, Feb 16
                        const dayStr = dateObj.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                        // Format: 10:00 AM (or 'All Day')
                        const timeStr = ev.isAllDay ? 'All Day' : dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        return `
                            <li>
                                <span class="event-time">${dayStr} &bull; ${timeStr}</span><br>
                                <span class="event-title">${ev.title}</span>
                            </li>
                        `;
                    }).join('');
                    document.getElementById('calendar-events-list').innerHTML = eventsHTML;
                } else {
                    document.getElementById('calendar-events-list').innerHTML = "<li>No upcoming events in the next 7 days.</li>";
                }

            } catch (error) {
                console.error("Error fetching Dashboard data:", error);
                document.getElementById('dashboard-stats').innerHTML = "<p>Could not load spreadsheet data.</p>";
                document.getElementById('calendar-events-list').innerHTML = "<p>Could not load calendar data.</p>";
            }
        };

        // --- WAKE LOCK LOGIC ---
        async function requestWakeLock() {
            try {
                wakeLock = await navigator.wakeLock.request('screen');
                updateStatusText();
            } catch (err) { console.error(`Wake Lock Error: ${err.name}, ${err.message}`); }
        }

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible' && !isPaused && timeRemainingMs > 0) {
                await requestWakeLock();
            }
        });

        // --- SCREENSAVER LOGIC ---
        function startScreensaver() {
            clearInterval(screensaverInterval);
            screensaverInterval = setInterval(() => {
                document.getElementById(`page-${currentPageIndex}`).classList.remove('active');
                currentPageIndex = (currentPageIndex + 1) % totalPages;
                document.getElementById(`page-${currentPageIndex}`).classList.add('active');
                document.body.style.backgroundColor = burnInColors[Math.floor(Math.random() * burnInColors.length)];
            }, 12000); 
            updateStatusText(true);
        }

        function stopScreensaver() {
            clearInterval(screensaverInterval);
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            currentPageIndex = 0;
            document.getElementById('page-0').classList.add('active');
            document.body.style.backgroundColor = '#121212'; 
            updateStatusText(false);
        }

        function calculatePomodoros(totalMinutes) {
            const planDiv = document.getElementById('pomodoro-plan');
            if (totalMinutes <= 25) { planDiv.innerText = ""; return; }
            planDiv.innerText = `Auto-Split: ${Math.ceil(totalMinutes / 25)} Pomodoro Sessions`;
        }

        // --- ICS CALENDAR EXPORT LOGIC ---
        function formatICSDate(date) {
            return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
        }

        function exportToICS() {
            const taskName = document.getElementById('task-name').value || "Focus Session";
            const category = document.getElementById('task-category').value;
            const minutes = parseInt(document.getElementById('minutes-input').value) || 60;
            
            const startDate = new Date();
            const endDate = new Date(startDate.getTime() + minutes * 60000);
            
            const dtStart = formatICSDate(startDate);
            const dtEnd = formatICSDate(endDate);

            const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Your Web App//Task Organizer//EN
BEGIN:VEVENT
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${taskName}
DESCRIPTION:Category: ${category}\\nScheduled via Task Organizer
LOCATION:Cincinnati\\, OH
STATUS:CONFIRMED
BEGIN:VALARM
TRIGGER:-PT5M
ACTION:DISPLAY
DESCRIPTION:Reminder
END:VALARM
END:VEVENT
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', `${taskName.replace(/\\s+/g, '_')}.ics`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- TIMER CONTROLS ---
        function startNewTask() {
            const taskName = document.getElementById('task-name').value;
            if (!taskName) return alert("Please enter a task name.");

            const minutes = parseInt(document.getElementById('minutes-input').value);
            if (isNaN(minutes) || minutes <= 0) return alert("Please enter valid minutes.");
            
            const now = new Date();
            sessionDate = now.toLocaleDateString(); 
            sessionStartTime = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 

            timeRemainingMs = minutes * 60 * 1000;
            isPaused = false;
            
            calculatePomodoros(minutes);
            
            document.getElementById('setup-controls').style.display = 'none';
            document.getElementById('active-controls').style.display = 'flex';
            document.getElementById('pause-btn').innerText = "Pause";

            runTimer();
        }

        function runTimer() {
            endTimeMs = Date.now() + timeRemainingMs;
            requestWakeLock();
            startScreensaver(); 

            clearInterval(countdownInterval); 
            countdownInterval = setInterval(() => {
                timeRemainingMs = endTimeMs - Date.now();
                if (timeRemainingMs <= 0) {
                    finishTask();
                    alert("Time's up! Take a break.");
                    return;
                }
                updateDisplay(timeRemainingMs);
            }, 1000);
        }

        function togglePause() {
            const pauseBtn = document.getElementById('pause-btn');
            if (isPaused) {
                isPaused = false; pauseBtn.innerText = "Pause"; runTimer();
            } else {
                isPaused = true; pauseBtn.innerText = "Resume"; clearInterval(countdownInterval); 
                stopScreensaver(); 
                if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
                updateStatusText(false);
            }
        }

        // --- FINISH & LOG TO GOOGLE SHEETS ---
        function finishTask() {
            clearInterval(countdownInterval);
            stopScreensaver();
            if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }

            const sessionEndTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const taskName = document.getElementById('task-name').value;
            const category = document.getElementById('task-category').value;

            const payload = {
                date: sessionDate,
                startTime: sessionStartTime,
                endTime: sessionEndTime,
                taskName: taskName,
                category: category
            };

            const syncStatus = document.getElementById('sync-status');
            syncStatus.innerText = "Logging
